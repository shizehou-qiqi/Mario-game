<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©¬é‡Œå¥¥æ¸¸æˆæ§åˆ¶å°è°ƒè¯•</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1e1e1e;
            color: #fff;
            font-family: 'Courier New', monospace;
        }
        
        #console {
            background: #000;
            border: 1px solid #333;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 14px;
        }
        
        #controls {
            margin: 20px 0;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            background: #007acc;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 3px;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        .error { color: #ff6b6b; }
        .success { color: #51cf66; }
        .warning { color: #ffd43b; }
        .info { color: #74c0fc; }
    </style>
</head>
<body>
    <h1>ğŸ”§ é©¬é‡Œå¥¥æ¸¸æˆæ§åˆ¶å°è°ƒè¯•</h1>
    
    <div id="controls">
        <button onclick="checkGameState()">æ£€æŸ¥æ¸¸æˆçŠ¶æ€</button>
        <button onclick="checkInputManager()">æ£€æŸ¥è¾“å…¥ç®¡ç†å™¨</button>
        <button onclick="checkPlayer()">æ£€æŸ¥ç©å®¶çŠ¶æ€</button>
        <button onclick="checkGameObjects()">æ£€æŸ¥æ¸¸æˆå¯¹è±¡</button>
        <button onclick="forceStartGame()">å¼ºåˆ¶å¼€å§‹æ¸¸æˆ</button>
        <button onclick="startRealTimeMonitor()">å¼€å§‹å®æ—¶ç›‘æ§</button>
        <button onclick="stopRealTimeMonitor()">åœæ­¢å®æ—¶ç›‘æ§</button>
        <button onclick="testPhysics()">æµ‹è¯•ç‰©ç†ç³»ç»Ÿ</button>
        <button onclick="testGameLoop()">æµ‹è¯•æ¸¸æˆå¾ªç¯</button>
        <button onclick="testCallbacks()">æµ‹è¯•å›è°ƒç³»ç»Ÿ</button>
        <button onclick="clearConsole()">æ¸…é™¤æ§åˆ¶å°</button>
    </div>
    
    <div id="console"></div>

    <script>
        let consoleDiv = document.getElementById('console');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            consoleDiv.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }
        
        function clearConsole() {
            consoleDiv.innerHTML = '';
        }
        
        function checkGameState() {
            log('=== æ£€æŸ¥æ¸¸æˆçŠ¶æ€ ===', 'info');

            // æ£€æŸ¥å…¨å±€å˜é‡
            const globals = ['gameEngine', 'gameStateManager', 'inputManager', 'player', 'currentLevel'];
            globals.forEach(varName => {
                if (window[varName]) {
                    log(`âœ… ${varName}: å·²å®šä¹‰`, 'success');
                } else {
                    log(`âŒ ${varName}: æœªå®šä¹‰`, 'error');
                }
            });

            // æ£€æŸ¥æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨
            if (window.gameStateManager) {
                log(`ğŸ® å½“å‰æ¸¸æˆçŠ¶æ€: ${window.gameStateManager.currentState}`, 'info');
            }

            // è¯¦ç»†æ£€æŸ¥æ¸¸æˆå¼•æ“
            if (window.gameEngine) {
                log(`ğŸ® æ¸¸æˆå¼•æ“è¿è¡ŒçŠ¶æ€: ${window.gameEngine.isRunning}`, 'info');
                log(`ğŸ® æ¸¸æˆå¼•æ“åŠ¨ç”»ID: ${window.gameEngine.animationId}`, 'info');
                log(`ğŸ® æ¸¸æˆå¯¹è±¡æ•°é‡: ${window.gameEngine.gameObjects.length}`, 'info');
                log(`ğŸ® å¸§ç‡: ${window.gameEngine.currentFPS.toFixed(1)} FPS`, 'info');

                // æ£€æŸ¥updateæ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨
                if (window.gameEngine.frameCount) {
                    log(`ğŸ® æ€»å¸§æ•°: ${window.gameEngine.frameCount}`, 'success');
                } else {
                    log(`âŒ æ¸¸æˆå¾ªç¯å¯èƒ½æ²¡æœ‰è¿è¡Œ`, 'error');
                }
            }
        }
        
        function checkInputManager() {
            log('=== æ£€æŸ¥è¾“å…¥ç®¡ç†å™¨ ===', 'info');
            
            if (!window.inputManager) {
                log('âŒ è¾“å…¥ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            log('âœ… è¾“å…¥ç®¡ç†å™¨å·²åˆå§‹åŒ–', 'success');
            
            // æ£€æŸ¥æŒ‰é”®çŠ¶æ€
            const keys = ['ArrowLeft', 'ArrowRight', 'Space', 'ArrowUp'];
            keys.forEach(key => {
                const pressed = window.inputManager.isKeyPressed(key);
                log(`ğŸ® ${key}: ${pressed}`, pressed ? 'warning' : 'info');
            });
            
            // æ˜¾ç¤ºæ‰€æœ‰æŒ‰ä¸‹çš„é”®
            const pressedKeys = Object.keys(window.inputManager.keys).filter(key => window.inputManager.keys[key]);
            if (pressedKeys.length > 0) {
                log(`ğŸ”¥ å½“å‰æŒ‰ä¸‹çš„é”®: ${pressedKeys.join(', ')}`, 'warning');
            } else {
                log('ğŸ“ å½“å‰æ²¡æœ‰æŒ‰é”®è¢«æŒ‰ä¸‹', 'info');
            }
        }
        
        function checkPlayer() {
            log('=== æ£€æŸ¥ç©å®¶çŠ¶æ€ ===', 'info');
            
            if (!window.player) {
                log('âŒ ç©å®¶å¯¹è±¡æœªåˆ›å»º', 'error');
                return;
            }
            
            log('âœ… ç©å®¶å¯¹è±¡å·²åˆ›å»º', 'success');
            log(`ğŸ“ ä½ç½®: (${window.player.position.x.toFixed(1)}, ${window.player.position.y.toFixed(1)})`, 'info');
            log(`ğŸƒ é€Ÿåº¦: (${window.player.velocity.x.toFixed(1)}, ${window.player.velocity.y.toFixed(1)})`, 'info');
            log(`ğŸŒ æ˜¯å¦åœ¨åœ°é¢: ${window.player.isGrounded}`, 'info');
            
            if (window.player.inputState) {
                log('ğŸ® è¾“å…¥çŠ¶æ€:', 'info');
                Object.entries(window.player.inputState).forEach(([key, value]) => {
                    log(`  ${key}: ${value}`, value ? 'warning' : 'info');
                });
            } else {
                log('âŒ ç©å®¶è¾“å…¥çŠ¶æ€æœªåˆå§‹åŒ–', 'error');
            }
        }
        
        function checkGameObjects() {
            log('=== æ£€æŸ¥æ¸¸æˆå¯¹è±¡ ===', 'info');
            
            if (!window.gameEngine) {
                log('âŒ æ¸¸æˆå¼•æ“æœªåˆå§‹åŒ–', 'error');
                return;
            }
            
            const objects = window.gameEngine.gameObjects;
            log(`ğŸ“¦ æ¸¸æˆå¯¹è±¡æ€»æ•°: ${objects.length}`, 'info');
            
            // æŒ‰ç±»å‹åˆ†ç»„
            const objectTypes = {};
            objects.forEach(obj => {
                const type = obj.tag || obj.constructor.name;
                objectTypes[type] = (objectTypes[type] || 0) + 1;
            });
            
            Object.entries(objectTypes).forEach(([type, count]) => {
                log(`  ${type}: ${count}ä¸ª`, 'info');
            });
            
            // æ£€æŸ¥å…³å¡
            if (window.currentLevel) {
                log(`ğŸ—ºï¸ å…³å¡å·²åŠ è½½: ${window.currentLevel.isLoaded}`, 'success');
                log(`ğŸ—ºï¸ å…³å¡å°ºå¯¸: ${window.currentLevel.width}x${window.currentLevel.height}`, 'info');
                log(`ğŸ—ºï¸ å¹³å°æ•°é‡: ${window.currentLevel.platforms.length}`, 'info');
                log(`ğŸ—ºï¸ æ•Œäººæ•°é‡: ${window.currentLevel.enemies.length}`, 'info');
            } else {
                log('âŒ å…³å¡æœªåŠ è½½', 'error');
            }
        }
        
        function forceStartGame() {
            log('=== å¼ºåˆ¶å¼€å§‹æ¸¸æˆ ===', 'warning');

            if (window.gameStateManager) {
                try {
                    window.gameStateManager.startGame();
                    log('âœ… æ¸¸æˆå¯åŠ¨å‘½ä»¤å·²å‘é€', 'success');
                } catch (error) {
                    log(`âŒ å¯åŠ¨æ¸¸æˆå¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                log('âŒ æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨æœªåˆå§‹åŒ–', 'error');
            }
        }

        let monitorInterval = null;

        function startRealTimeMonitor() {
            if (monitorInterval) {
                log('âš ï¸ å®æ—¶ç›‘æ§å·²åœ¨è¿è¡Œ', 'warning');
                return;
            }

            log('ğŸ”„ å¼€å§‹å®æ—¶ç›‘æ§ç©å®¶çŠ¶æ€...', 'info');

            monitorInterval = setInterval(() => {
                if (window.player && window.inputManager) {
                    const p = window.player;
                    const im = window.inputManager;

                    // æ¸…é™¤æ§åˆ¶å°å¹¶æ˜¾ç¤ºå®æ—¶çŠ¶æ€
                    clearConsole();
                    log('=== å®æ—¶ç©å®¶ç›‘æ§ ===', 'info');
                    log(`ä½ç½®: (${p.position.x.toFixed(1)}, ${p.position.y.toFixed(1)})`, 'info');
                    log(`é€Ÿåº¦: (${p.velocity.x.toFixed(1)}, ${p.velocity.y.toFixed(1)})`, 'info');
                    log(`åœ¨åœ°é¢: ${p.isGrounded}`, p.isGrounded ? 'success' : 'warning');
                    log(`é‡åŠ›å¯ç”¨: ${p.useGravity}`, 'info');
                    log(`ç¢°æ’å¯ç”¨: ${p.collisionEnabled}`, 'info');

                    log('è¾“å…¥çŠ¶æ€:', 'info');
                    log(`  å·¦: ${p.inputState.left} | å³: ${p.inputState.right}`, 'info');
                    log(`  è·³è·ƒ: ${p.inputState.jump} | è·³è·ƒæŒ‰ä¸‹: ${p.inputState.jumpPressed}`, 'info');

                    log('åŸå§‹è¾“å…¥:', 'info');
                    log(`  ArrowLeft: ${im.isKeyPressed('ArrowLeft')}`, 'info');
                    log(`  ArrowRight: ${im.isKeyPressed('ArrowRight')}`, 'info');
                    log(`  Space: ${im.isKeyPressed('Space')}`, 'info');

                    // æ£€æŸ¥æ˜¯å¦æœ‰é€Ÿåº¦å˜åŒ–
                    if (Math.abs(p.velocity.x) > 0.1 || Math.abs(p.velocity.y) > 0.1) {
                        log('ğŸƒ ç©å®¶æ­£åœ¨ç§»åŠ¨ï¼', 'success');
                    } else {
                        log('ğŸš« ç©å®¶é™æ­¢', 'warning');
                    }
                }
            }, 100); // æ¯100msæ›´æ–°ä¸€æ¬¡
        }

        function stopRealTimeMonitor() {
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
                log('â¹ï¸ å®æ—¶ç›‘æ§å·²åœæ­¢', 'info');
            } else {
                log('âš ï¸ å®æ—¶ç›‘æ§æœªè¿è¡Œ', 'warning');
            }
        }

        function testPhysics() {
            log('=== æµ‹è¯•ç‰©ç†ç³»ç»Ÿ ===', 'warning');

            if (!window.player) {
                log('âŒ ç©å®¶å¯¹è±¡ä¸å­˜åœ¨', 'error');
                return;
            }

            const player = window.player;
            log(`ğŸ§ª æµ‹è¯•å‰ç©å®¶é€Ÿåº¦: (${player.velocity.x}, ${player.velocity.y})`, 'info');

            // ç›´æ¥æµ‹è¯•é‡åŠ›åº”ç”¨
            if (window.Physics) {
                log('âœ… Physicsç±»å­˜åœ¨', 'success');
                log(`ğŸŒ é‡åŠ›å¸¸é‡: ${window.Physics.GRAVITY}`, 'info');

                // æ‰‹åŠ¨åº”ç”¨é‡åŠ›
                const deltaTime = 1/60; // 1å¸§çš„æ—¶é—´
                const oldVelocityY = player.velocity.y;

                window.Physics.applyGravity(player, deltaTime);

                log(`ğŸ§ª æ‰‹åŠ¨åº”ç”¨é‡åŠ›åé€Ÿåº¦: (${player.velocity.x}, ${player.velocity.y})`, 'info');
                log(`ğŸ“ˆ Yé€Ÿåº¦å˜åŒ–: ${oldVelocityY} -> ${player.velocity.y}`, 'info');

                if (player.velocity.y > oldVelocityY) {
                    log('âœ… é‡åŠ›æ­£å¸¸å·¥ä½œï¼', 'success');
                } else {
                    log('âŒ é‡åŠ›æ²¡æœ‰æ•ˆæœï¼', 'error');
                }
            } else {
                log('âŒ Physicsç±»ä¸å­˜åœ¨', 'error');
            }

            // æ£€æŸ¥ç©å®¶çš„ç‰©ç†å±æ€§
            log('ğŸ” ç©å®¶ç‰©ç†å±æ€§:', 'info');
            log(`  useGravity: ${player.useGravity}`, 'info');
            log(`  gravityScale: ${player.gravityScale}`, 'info');
            log(`  velocityå¯¹è±¡: ${player.velocity ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, 'info');

            if (player.velocity) {
                log(`  velocityç±»å‹: ${player.velocity.constructor.name}`, 'info');
                log(`  velocity.yç±»å‹: ${typeof player.velocity.y}`, 'info');
            }
        }

        function testGameLoop() {
            log('=== æµ‹è¯•æ¸¸æˆå¾ªç¯ ===', 'warning');

            if (!window.gameEngine) {
                log('âŒ æ¸¸æˆå¼•æ“ä¸å­˜åœ¨', 'error');
                return;
            }

            const engine = window.gameEngine;

            // è®°å½•åˆå§‹çŠ¶æ€
            const initialFrameCount = engine.frameCount || 0;
            const initialTime = performance.now();

            log(`ğŸ” åˆå§‹å¸§æ•°: ${initialFrameCount}`, 'info');
            log(`ğŸ” æ¸¸æˆå¼•æ“è¿è¡ŒçŠ¶æ€: ${engine.isRunning}`, 'info');
            log(`ğŸ” åŠ¨ç”»ID: ${engine.animationId}`, 'info');

            // ç­‰å¾…ä¸€æ®µæ—¶é—´åæ£€æŸ¥å¸§æ•°æ˜¯å¦å¢åŠ 
            setTimeout(() => {
                const currentFrameCount = engine.frameCount || 0;
                const currentTime = performance.now();
                const timeDiff = currentTime - initialTime;
                const frameDiff = currentFrameCount - initialFrameCount;

                log(`â±ï¸ ç»è¿‡æ—¶é—´: ${timeDiff.toFixed(1)}ms`, 'info');
                log(`ğŸ“Š å¸§æ•°å˜åŒ–: ${initialFrameCount} -> ${currentFrameCount} (å¢åŠ ${frameDiff})`, 'info');

                if (frameDiff > 0) {
                    const actualFPS = (frameDiff / timeDiff) * 1000;
                    log(`âœ… æ¸¸æˆå¾ªç¯æ­£å¸¸è¿è¡Œï¼å®é™…FPS: ${actualFPS.toFixed(1)}`, 'success');
                } else {
                    log(`âŒ æ¸¸æˆå¾ªç¯æ²¡æœ‰è¿è¡Œï¼å¸§æ•°æ²¡æœ‰å¢åŠ `, 'error');

                    // å°è¯•æ‰‹åŠ¨å¯åŠ¨æ¸¸æˆå¾ªç¯
                    log(`ğŸ”§ å°è¯•é‡æ–°å¯åŠ¨æ¸¸æˆå¼•æ“...`, 'warning');
                    try {
                        engine.stop();
                        engine.start();
                        log(`âœ… æ¸¸æˆå¼•æ“é‡å¯æˆåŠŸ`, 'success');
                    } catch (error) {
                        log(`âŒ æ¸¸æˆå¼•æ“é‡å¯å¤±è´¥: ${error.message}`, 'error');
                    }
                }
            }, 1000); // ç­‰å¾…1ç§’
        }

        function testCallbacks() {
            log('=== æµ‹è¯•å›è°ƒç³»ç»Ÿ ===', 'warning');

            if (!window.gameStateManager) {
                log('âŒ æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ä¸å­˜åœ¨', 'error');
                return;
            }

            const gsm = window.gameStateManager;

            // æ£€æŸ¥å›è°ƒæ˜¯å¦å·²æ³¨å†Œ
            log('ğŸ” æ£€æŸ¥å·²æ³¨å†Œçš„å›è°ƒ:', 'info');
            const callbacks = gsm.stateChangeCallbacks;
            if (callbacks) {
                Object.keys(callbacks).forEach(event => {
                    log(`  ${event}: ${typeof callbacks[event]}`, 'info');
                });

                if (Object.keys(callbacks).length === 0) {
                    log('âŒ æ²¡æœ‰æ³¨å†Œä»»ä½•å›è°ƒï¼', 'error');
                } else {
                    log(`âœ… å·²æ³¨å†Œ ${Object.keys(callbacks).length} ä¸ªå›è°ƒ`, 'success');
                }
            } else {
                log('âŒ stateChangeCallbacks ä¸å­˜åœ¨', 'error');
            }

            // æµ‹è¯•æ‰‹åŠ¨è§¦å‘gameStartå›è°ƒ
            log('ğŸ§ª æ‰‹åŠ¨è§¦å‘ gameStart å›è°ƒ...', 'warning');
            try {
                gsm.triggerCallback('gameStart');
                log('âœ… gameStart å›è°ƒè§¦å‘æˆåŠŸ', 'success');

                // æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†ç©å®¶å’Œå…³å¡
                setTimeout(() => {
                    if (window.player) {
                        log('âœ… ç©å®¶å¯¹è±¡å·²åˆ›å»º', 'success');
                    } else {
                        log('âŒ ç©å®¶å¯¹è±¡æœªåˆ›å»º', 'error');
                    }

                    if (window.currentLevel) {
                        log('âœ… å…³å¡å¯¹è±¡å·²åˆ›å»º', 'success');
                    } else {
                        log('âŒ å…³å¡å¯¹è±¡æœªåˆ›å»º', 'error');
                    }
                }, 100);

            } catch (error) {
                log(`âŒ è§¦å‘å›è°ƒå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥
        window.addEventListener('load', () => {
            setTimeout(() => {
                log('ğŸš€ è°ƒè¯•æ§åˆ¶å°å·²å‡†å¤‡å°±ç»ª', 'success');
                checkGameState();
            }, 1000);
        });
        
        // ç›‘å¬æŒ‰é”®äº‹ä»¶ç”¨äºè°ƒè¯•
        document.addEventListener('keydown', (e) => {
            log(`âŒ¨ï¸ æŒ‰é”®æŒ‰ä¸‹: ${e.code}`, 'warning');
        });
        
        document.addEventListener('keyup', (e) => {
            log(`âŒ¨ï¸ æŒ‰é”®é‡Šæ”¾: ${e.code}`, 'info');
        });
    </script>
</body>
</html>
